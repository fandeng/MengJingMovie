//
//  CityTableViewController.m
//  Homepage_MengJingMovies
//
//  Created by lanou3g on 15/10/20.
//  Copyright (c) 2015å¹´ lanou3g. All rights reserved.
//

#import "CityTableViewController.h"
#import "ShareRequestData.h"
#import "CityModel.h"
#import "HomepageViewController.h"
#import "FHotCityView.h"

@interface CityTableViewController ()<shareRequestDataDateSource,fHotCityViewDelegate>

@property(nonatomic, strong)NSMutableArray * allCityArray;//å­˜æ”¾å­—å…¸æ‰€æœ‰çš„key

@property(nonatomic, strong)CityModel * cityModel;//modelå¯¹è±¡

@property(nonatomic, strong)NSMutableDictionary * allCityDic;//æŒ‰ç…§é¦–å­—æ¯å¯¹åŸå¸‚åˆ†ç±»

@end

@implementation CityTableViewController
//æ‡’åŠ è½½
- (NSMutableArray *)allCityArray
{
    if (_allCityArray == nil) {
        
        _allCityArray = [NSMutableArray array];
    }
    return _allCityArray;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    //åˆ›å»ºå•ä¾‹ç±» å¹¶ç»‘å®šä»£ç†
    ShareRequestData * handleData = [[ShareRequestData alloc] initWithUrlByString:kCityUrl];
    
    handleData.datesource = self;
    
    [[ShareRequestData sharedManager] loadProgress:self.view];
    
    [self createHeaderView];
    
    //æ”¹å˜ç´¢å¼•çš„é¢œè‰²
    self.tableView.sectionIndexColor = [UIColor orangeColor];
    //æ”¹å˜ç´¢å¼•é€‰ä¸­çš„èƒŒæ™¯é¢œè‰²
    self.tableView.sectionIndexTrackingBackgroundColor = [UIColor colorWithRed:0.400 green:1.000 blue:1.000 alpha:1.000];
}
//è¿”å›äº‹ä»¶
- (IBAction)backAction:(id)sender {
    
    [self dismissViewControllerAnimated:YES completion:nil];
}
#pragma mark ----å®ç°åè®®æ–¹æ³•
- (void)shareRequestData:(ShareRequestData *)requestHandle didSucceedWithData:(NSData *)data
{
    if (data != nil) {
        [[ShareRequestData sharedManager] opinionHide:YES];
        NSMutableDictionary * dic = [NSJSONSerialization JSONObjectWithData:data options:NSJSONReadingMutableContainers error:nil];
        
        self.allCityDic = [NSMutableDictionary dictionary];
        for (NSDictionary * dict in dic[@"p"]) {
            
            self.cityModel = [[CityModel alloc] init];
            
            [_cityModel setValuesForKeysWithDictionary:dict];
            
            NSString * firstName = [_cityModel.pinyinFull firstCharacterOfString];
            
            //åˆ¤æ–­å­—å…¸æ˜¯å¦æœ‰è¿™ä¸ªkey
            if (_allCityDic[firstName]) {
                NSMutableArray * array = _allCityDic[firstName];
                [array addObject:_cityModel];
                [_allCityDic setValue:array forKey:firstName];
                
            } else {
                NSMutableArray * array = [NSMutableArray array];
                [array addObject:_cityModel];
                [_allCityDic setValue:array forKey:firstName];
            }
        }
        [self.allCityArray addObjectsFromArray:_allCityDic.allKeys];//å–å‡ºæ‰€æœ‰çš„key
        //å¯¹keyè¿›è¡Œæ’åº
        [_allCityArray sortUsingSelector:@selector(compare:)];
        
        [self.tableView reloadData];//åˆ·æ–°è§†å›¾
    }
}

#pragma mark - Table view data source

- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView {
    
    return _allCityArray.count;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    
    return [_allCityDic[_allCityArray[section]] count];
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@"cityCell_id" forIndexPath:indexPath];
    if (!cell) {
        
        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:@"cityCell_id"];
    }
#pragma mark ---æ ¹æ®keyå–å‡ºvalueå¯¹åº”çš„model
    CityModel * model = _allCityDic[_allCityArray[indexPath.section]][indexPath.row];
    
    cell.textLabel.text = model.cityName;
    
    return cell;
}
//è¡Œé«˜
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    return 50;
}
//ç´¢å¼•
- (NSArray *)sectionIndexTitlesForTableView:(UITableView *)tableView
{
    return _allCityArray;
}
//åˆ†åŒºå†…å®¹
- (NSString *)tableView:(UITableView *)tableView titleForHeaderInSection:(NSInteger)section
{
    return _allCityArray[section];
}
//ç‚¹å‡»cell è§¦å‘äº‹ä»¶
- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    //è·å–å¯¹åº”çš„åŸå¸‚
    CityModel * model = _allCityDic[_allCityArray[indexPath.section]][indexPath.row];
    //å“åº”é€šçŸ¥ï¼Œå°†åŸå¸‚çš„idä¼ åˆ°é¦–é¡µ
    [[NSNotificationCenter defaultCenter] postNotificationName:@"makeCityId" object:self userInfo:@{@"cityId":[NSString stringWithFormat:@"%ld",model.cityId],@"cityName":[NSString stringWithFormat:@"%@ğŸ”½",model.cityName]}];
    
    [self dismissViewControllerAnimated:YES completion:nil];
}
//è®¾ç½®è¡¨å¤´
- (void)createHeaderView
{
    FHotCityView * hotCityView = [[NSBundle mainBundle] loadNibNamed:@"FHotCityView" owner:self options:nil].firstObject;
    
    hotCityView.delegate = self;
    
    hotCityView.currentCityLable.text = [ShareRequestData sharedManager].city;
    
    self.tableView.tableHeaderView = hotCityView;
}
#pragma mark ----å®ç°fHotCityViewDelegateåè®®æ–¹æ³•
- (void)fHotCityViewWithShanghaiAction{
    [[NSNotificationCenter defaultCenter] postNotificationName:@"makeCityId" object:self userInfo:@{@"cityId":@"292",@"cityName":@"ä¸Šæµ·ğŸ”½"}];
    
    [self dismissViewControllerAnimated:YES completion:nil];
}

- (void)fHotCityViewWithBJAction{
    [[NSNotificationCenter defaultCenter] postNotificationName:@"makeCityId" object:self userInfo:@{@"cityId":@"290",@"cityName":@"åŒ—äº¬ğŸ”½"}];
    
    [self dismissViewControllerAnimated:YES completion:nil];
}

- (void)fHotCityViewWithShenzhenAction{
    [[NSNotificationCenter defaultCenter] postNotificationName:@"makeCityId" object:self userInfo:@{@"cityId":@"366",@"cityName":@"æ·±åœ³ğŸ”½"}];
    
    [self dismissViewControllerAnimated:YES completion:nil];
}

- (void)fHotCityViewWithTianjinAction{
    [[NSNotificationCenter defaultCenter] postNotificationName:@"makeCityId" object:self userInfo:@{@"cityId":@"293",@"cityName":@"å¤©æ´¥ğŸ”½"}];
    
    [self dismissViewControllerAnimated:YES completion:nil];
}

- (void)fHotCityViewWithChengduAction{
    [[NSNotificationCenter defaultCenter] postNotificationName:@"makeCityId" object:self userInfo:@{@"cityId":@"880",@"cityName":@"æˆéƒ½ğŸ”½"}];
    
    [self dismissViewControllerAnimated:YES completion:nil];
}

- (void)fHotCityViewWithChongqingAction{
    [[NSNotificationCenter defaultCenter] postNotificationName:@"makeCityId" object:self userInfo:@{@"cityId":@"291",@"cityName":@"é‡åº†ğŸ”½"}];
    
    [self dismissViewControllerAnimated:YES completion:nil];
}

- (void)fHotCityViewWithWuhanAction{
    [[NSNotificationCenter defaultCenter] postNotificationName:@"makeCityId" object:self userInfo:@{@"cityId":@"561",@"cityName":@"æ­¦æ±‰ğŸ”½"}];
    
    [self dismissViewControllerAnimated:YES completion:nil];
}

- (void)fHotCityViewWithHangzhouAction{
    [[NSNotificationCenter defaultCenter] postNotificationName:@"makeCityId" object:self userInfo:@{@"cityId":@"974",@"cityName":@"æ­å·ğŸ”½"}];
    
    [self dismissViewControllerAnimated:YES completion:nil];
}

- (void)fHotCityViewWithGuangzhouAction{
    [[NSNotificationCenter defaultCenter] postNotificationName:@"makeCityId" object:self userInfo:@{@"cityId":@"365",@"cityName":@"å¹¿å·ğŸ”½"}];
    
    [self dismissViewControllerAnimated:YES completion:nil];
}






@end
